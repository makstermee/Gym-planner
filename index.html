<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trening Pro </title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Wymagane skrypty Firebase -->
<script type="module">
  // --- Globalne zmienne dostarczone przez rodowisko Canvas (MUSZ by u偶yte) ---
  // U偶ywamy typeof dla bezpieczestwa
  const __firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
  const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
  const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  const firebaseConfig = JSON.parse(__firebase_config);

  // Sprawd藕, czy konfiguracja jest kompletna
  window.IS_FIREBASE_CONFIGURED = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey;
  window.appId = __app_id; // Ustaw globalnie ID aplikacji

  // Ustawienie globalnych referencji (dostpnych w app.js)
  window.app, window.auth, window.db;

  // Sprawd藕, czy konfiguracja Firebase istnieje.
  if (window.IS_FIREBASE_CONFIGURED) {
    // Modularne importy Firebase (zamiast CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, 
             signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Inicjalizacja usug
    window.app = initializeApp(firebaseConfig);
    window.auth = getAuth(window.app);
    window.db = getFirestore(window.app);
    setLogLevel('debug'); // Wcz logowanie dla Firestore

    console.log("Firebase configured and initialized with Firestore.");

    // Pr贸ba logowania tokenem Canvas, jeli dostpny
    if (__initial_auth_token) {
        signInWithCustomToken(window.auth, __initial_auth_token)
            .then(userCredential => console.log("Canvas initial sign-in successful:", userCredential.user.uid))
            .catch(error => {
                console.warn("Canvas custom token sign-in failed. Proceeding with onAuthStateChanged.", error.message);
            });
    }

  } else {
    // --- Mockowanie (w przypadku braku konfiguracji) ---
    console.error("Firebase configuration missing. Cloud login will not work.");
    // Zapewniamy minimalne, nierealne implementacje, aby kod si nie zama
    window.auth = { onAuthStateChanged: (cb) => { setTimeout(() => cb(null), 100); return () => {}; }, signOut: async () => {}, signInWithEmailAndPassword: async () => { throw new Error('Brak konfiguracji Firebase.'); }, createUserWithEmailAndPassword: async () => { throw new Error('Brak konfiguracji Firebase.'); }};
    window.db = {};
  }
</script>

<header class="top">
  <h1>Trening Pro<span id="welcomeMsg"></span></h1>
  <div id="masterTimerDisplay" class="master-timer" style="display:none;">00:00:00</div>
</header>

<main class="container">

  <!-- Panel: Autoryzacja - Jest teraz domylnie AKTYWNY, dop贸ki nie nastpi logowanie -->
  <section id="panel-auth" class="panel active">
    <h2>Zarzdzanie Kontem </h2>
    <div id="authStatusArea" style="text-align: center; margin-bottom: 20px;">
        <p id="currentAuthStatus" style="font-weight: bold; color: var(--text);"></p>
        <p id="authError" style="color: var(--danger); font-weight: bold;"></p>
    </div>

    <!-- Ostrze偶enie, jeli brakuje konfiguracji -->
    <div id="configWarning" style="background: var(--danger); color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
        <strong>Bd Konfiguracji Chmury!</strong><br>
        <p style="margin: 5px 0 0 0;">Autoryzacja i zapis na wielu urzdzeniach nie s dostpne, dop贸ki system nie dostarczy konfiguracji Firebase.</p>
    </div>

    <!-- Formularz Logowania/Rejestracji -->
    <div id="authForm">
        <p style="text-align: center; color: var(--muted); margin-top: 0;">Zaloguj si lub zarejestruj, aby zapisywa postpy.</p>
        <input id="authEmail" type="email" placeholder="E-mail" required />
        <input id="authPassword" type="password" placeholder="Haso (min. 6 znak贸w)" required />
        
        <div class="button-row" style="margin-top: 20px;">
          <button id="loginBtn" class="btn-success">Zaloguj</button>
          <button id="registerBtn" class="btn-secondary">Zarejestruj</button>
        </div>
        <button id="logoutBtn" class="btn-danger" style="display: none; width: 100%; margin-top: 20px;">Wyloguj si</button>
    </div>
    
    <hr style="margin-top: 30px; border-color: var(--muted-light);">
    <p style="font-size: 0.8em; text-align: center; color: var(--muted);">
        ID U偶ytkownika (wymagany do zapis贸w): <span id="currentUserIdDisplay" style="font-weight: bold; color: var(--accent);">Brak ID</span>
    </p>
  </section>

  <!-- Panel: G贸wny (Lista dni) -->
  <section id="panel-main" class="panel">
    <h2>Plany Treningowe </h2>
    <div id="dayList" class="day-list">
      <!-- Tutaj wylduj przyciski dni tygodnia generowane przez JS -->
    </div>
  </section>
  
  <!-- Panel: Szczeg贸y Planu (Day Details) -->
  <section id="panel-plan-details" class="panel">
    <h2 id="planDetailsTitle">Plan: Poniedziaek</h2>
    <div id="planDetailsList" class="exercise-list">
      <!-- Lista wicze w planie -->
    </div>
    <div class="button-row" style="margin-top: 20px;">
      <button id="editPlanBtn" class="btn-secondary">Edytuj plan</button>
      <button id="startWorkoutBtn" class="btn-success">Rozpocznij trening</button>
    </div>
    <button id="backToMainBtn" class="btn-secondary" style="margin-top: 10px; width: 100%;">Powr贸t do listy dni</button>
  </section>

  <!-- Panel: Edytor Planu -->
  <section id="panel-edit-plan" class="panel">
    <h2 id="editPlanTitle">Edytuj: Dzie</h2>
    
    <h3>Dodaj wiczenie</h3>
    <div class="input-row">
      <input id="exName" placeholder="Nazwa wiczenia (np. Przysiady)" required />
      <input id="exTargetSets" type="number" min="1" value="3" placeholder="Serie" required style="flex: 0 0 80px;" />
      <input id="exTargetReps" type="number" min="1" value="10" placeholder="Powt." required style="flex: 0 0 80px;" />
      <button id="addExerciseBtn" style="flex: 0 0 80px;">Dodaj</button>
    </div>
    
    <h3>wiczenia w Planie</h3>
    <div id="editPlanList" class="exercise-list">
      <!-- Lista wicze do edycji -->
    </div>

    <div class="button-row" style="margin-top: 20px;">
      <button id="savePlanChangesBtn" class="btn-success">Zapisz zmiany i wr贸</button>
    </div>
  </section>

  <!-- Panel: Aktywny Trening -->
  <section id="panel-active-workout" class="panel">
    <h2 id="activeWorkoutTitle">Aktywny Trening</h2>
    <div id="activeWorkoutList" class="exercise-list">
      <!-- Dynamiczna lista wicze z formularzem logowania serii -->
    </div>
    
    <button id="finishWorkoutBtn" class="btn-danger" style="margin-top: 20px; width: 100%;">Zakocz Trening i Zapisz Log</button>
  </section>


  <!-- Panel: Logi (Historia) -->
  <section id="panel-logs" class="panel">
    <h2>Historia Log贸w </h2>
    <div id="logArea" class="log-area">
      <!-- Logi treningowe -->
    </div>
    
    <div class="button-row" style="margin-top: 20px;">
      <button id="clearHistory" class="btn-danger">Wyczy histori</button>
      <button id="exportBtn">Eksportuj JSON</button>
      <button id="importBtn" class="btn-secondary">Importuj JSON</button>
      <input type="file" id="fileInput" style="display:none" accept=".json">
    </div>
  </section>

  <!-- Panel: Statystyki -->
  <section id="panel-stats" class="panel">
    <h2>Statystyki </h2>
    <canvas id="statsChart" height="250"></canvas>
    <p style="text-align: center; color: var(--muted); margin-top: 10px;">Objto treningowa (kg * powt贸rzenia) w czasie.</p>
  </section>

  <!-- Panel: Ustawienia -->
  <section id="panel-settings" class="panel">
    <h2>Ustawienia 锔</h2>
    
    <label for="loggedUserEmailDisplay" style="font-size: 0.9em; margin-bottom: 5px;">Status konta:</label>
    <p id="loggedUserEmailDisplay" style="font-weight: bold; margin-bottom: 20px; color: var(--accent);"></p>

    <label for="themeSelect">Motyw aplikacji:</label>
    <select id="themeSelect">
      <option value="light">Jasny (domylny)</option>
      <option value="dark">Ciemny</option>
    </select>
  </section>

</main>

<!-- Dolne menu nawigacyjne (domylnie ukryte, by wymusi logowanie) -->
<nav class="bottom-nav" id="bottomNav" style="display: none;">
  <button data-panel="panel-main">Plan</button>
  <button data-panel="panel-logs">Logi</button>
  <button data-panel="panel-stats">Statystyki</button>
  <button data-panel="panel-settings">Ustawienia</button>
  <button data-panel="panel-auth">Konto</button>
</nav>

<script type="module" src="app.js"></script>
</body>
</html>

